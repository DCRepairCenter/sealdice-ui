name: Build and Release Pre-release

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´ 00:00 å’Œ 12:00)

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest
        
    - name: Get build info
      id: build_info
      run: |
        echo "build_time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        echo "commit_hash=${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "commit_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
        echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        echo "trigger=${{ github.event_name }}" >> $GITHUB_OUTPUT
        
    - name: Install dependencies
      run: pnpm install
      
    - name: Create build config without legacy plugin
      run: |
        cat > vite.config.build.ts << 'EOF'
        import { fileURLToPath, URL } from 'node:url';
        import { defineConfig, loadEnv } from 'vite';
        import vue from '@vitejs/plugin-vue';
        import vueJsx from '@vitejs/plugin-vue-jsx';
        import AutoImport from 'unplugin-auto-import/vite';
        import Components from 'unplugin-vue-components/vite';
        import { ElementPlusResolver } from 'unplugin-vue-components/resolvers';
        import Icons from 'unplugin-icons/vite';
        import IconsResolver from 'unplugin-icons/resolver';

        export default defineConfig(({ mode }) => ({
          base: './',
          resolve: {
            alias: {
              '~': fileURLToPath(new URL('./src', import.meta.url)),
            },
          },
          plugins: [
            vue(),
            vueJsx(),
            AutoImport({
              include: [
                /\.[tj]sx?$/,
                /\.vue$/,
                /\.vue\?vue/,
              ],
              imports: ['vue', 'pinia', 'vue-router', '@vueuse/core'],
              dts: true,
              vueTemplate: true,
              resolvers: [
                ElementPlusResolver({
                  importStyle: 'css',
                }),
                IconsResolver(),
              ],
            }),
            Components({
              resolvers: [
                ElementPlusResolver({
                  importStyle: 'css',
                }),
                IconsResolver(),
              ],
            }),
            Icons({
              compiler: 'vue3',
              autoInstall: true,
            }),
          ],
          build: {
            sourcemap: false,
            chunkSizeWarningLimit: 1024,
            rollupOptions: {
              output: {
                manualChunks: {
                  base: ['vue', 'pinia', 'vue-router'],
                  codemirror: ['codemirror', '@codemirror/lang-javascript'],
                  common: ['element-plus', 'lodash-es'],
                  utils: [
                    '@vueuse/core',
                    'asmcrypto.js',
                    'axios',
                    'axios-retry',
                    'clipboard',
                    'dayjs',
                    'filesize',
                    'randomcolor',
                    'vue-diff',
                    'vuedraggable',
                  ],
                },
              },
            },
          },
        }));
        EOF
        
    - name: Build project
      id: build_step
      run: |
        # ä½¿ç”¨ä¸åŒ…å« legacy æ’ä»¶çš„é…ç½®æ–‡ä»¶è¿›è¡Œæ„å»º
        echo "ğŸš€ Starting build process..."
        if pnpm run build-only -- --config vite.config.build.ts; then
          echo "âœ… Build completed successfully"
          echo "build_success=true" >> $GITHUB_OUTPUT
          
          # è·å–æ„å»ºè¾“å‡ºä¿¡æ¯
          BUILD_SIZE=$(du -sh dist | cut -f1)
          FILE_COUNT=$(find dist -type f | wc -l)
          echo "build_size=$BUILD_SIZE" >> $GITHUB_OUTPUT
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Build statistics:"
          echo "   - Total size: $BUILD_SIZE"
          echo "   - File count: $FILE_COUNT"
        else
          echo "âŒ Build failed"
          echo "build_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
      
    - name: Create zip archive
      if: steps.build_step.outputs.build_success == 'true'
      run: |
        echo "ğŸ“¦ Creating zip archive..."
        cd dist
        zip -r ../sealdice-ui.zip .
        cd ..
        
        # è·å–zipæ–‡ä»¶å¤§å°
        ZIP_SIZE=$(du -sh sealdice-ui.zip | cut -f1)
        echo "ğŸ“„ Archive created: sealdice-ui.zip ($ZIP_SIZE)"
        
    - name: Check if pre-release exists
      if: steps.build_step.outputs.build_success == 'true'
      id: check_release
      run: |
        echo "ğŸ” Checking for existing pre-release..."
        RELEASE_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/releases/tags/pre-release" \
          | jq -r '.id // empty')
        
        if [ ! -z "$RELEASE_ID" ] && [ "$RELEASE_ID" != "null" ]; then
          echo "release_exists=true" >> $GITHUB_OUTPUT
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "ğŸ—‘ï¸  Pre-release exists with ID: $RELEASE_ID - will be replaced"
        else
          echo "release_exists=false" >> $GITHUB_OUTPUT
          echo "âœ¨ No existing pre-release found - will create new one"
        fi
        
    - name: Delete existing pre-release
      if: steps.build_step.outputs.build_success == 'true' && steps.check_release.outputs.release_exists == 'true'
      run: |
        echo "ğŸ—‘ï¸  Deleting existing pre-release..."
        curl -X DELETE \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/releases/${{ steps.check_release.outputs.release_id }}"
        echo "âœ… Deleted existing pre-release"
        
    - name: Delete existing pre-release tag
      if: steps.build_step.outputs.build_success == 'true' && steps.check_release.outputs.release_exists == 'true'
      run: |
        echo "ğŸ·ï¸  Deleting existing pre-release tag..."
        curl -X DELETE \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/pre-release"
        echo "âœ… Deleted existing pre-release tag"
      continue-on-error: true  # å¦‚æœtagä¸å­˜åœ¨ï¼Œç»§ç»­æ‰§è¡Œ
      
    - name: Create new pre-release
      if: steps.build_step.outputs.build_success == 'true'
      id: create_release
      run: |
        echo "ğŸš€ Creating new pre-release..."
        
        # åˆ›å»ºè¯¦ç»†çš„å‘å¸ƒè¯´æ˜
        cat > release_body.md << EOF
        # ğŸ¯ æµ·è±¹æ ¸å¿ƒå‰ç«¯ Pre-release æ„å»º
        
        ## ğŸ“‹ æ„å»ºä¿¡æ¯
        
        | é¡¹ç›® | ä¿¡æ¯ |
        |------|------|
        | ğŸ• æ„å»ºæ—¶é—´ | \`${{ steps.build_info.outputs.build_time }}\` |
        | ğŸ”§ è§¦å‘æ–¹å¼ | \`${{ steps.build_info.outputs.trigger }}\` |
        | ğŸŒ¿ åˆ†æ”¯ | \`${{ steps.build_info.outputs.branch }}\` |
        | ğŸ“ æäº¤å“ˆå¸Œ | \`${{ steps.build_info.outputs.commit_hash }}\` |
        | ğŸ“Š æ„å»ºå¤§å° | \`${{ steps.build_step.outputs.build_size }}\` |
        | ğŸ“ æ–‡ä»¶æ•°é‡ | \`${{ steps.build_step.outputs.file_count }}\` ä¸ªæ–‡ä»¶ |
        | ğŸ—ï¸ Node.js ç‰ˆæœ¬ | \`20\` |
        | ğŸ“¦ åŒ…ç®¡ç†å™¨ | \`pnpm\` |
        
        ## ğŸ“¥ ä¸‹è½½
        
        ç‚¹å‡»ä¸‹æ–¹çš„ **sealdice-ui.zip** ä¸‹è½½æœ€æ–°æ„å»ºç‰ˆæœ¬ã€‚
        
        ## âš ï¸ æ³¨æ„äº‹é¡¹
        
        - è¿™æ˜¯è‡ªåŠ¨æ„å»ºçš„é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªç»å……åˆ†æµ‹è¯•çš„åŠŸèƒ½
        - å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨
        - å¦‚é‡é—®é¢˜è¯·åœ¨ [sealdice-core](https://github.com/sealdice/sealdice-core) ä»“åº“æäº¤ Issue
        
        ## ğŸ”„ è‡ªåŠ¨æ„å»º
        
        æ­¤ç‰ˆæœ¬æ¯12å°æ—¶è‡ªåŠ¨æ„å»ºä¸€æ¬¡ï¼Œç¡®ä¿ä¸æœ€æ–°ä»£ç åŒæ­¥ã€‚
        EOF
        
        RELEASE_BODY=$(cat release_body.md | jq -Rs .)
        
        RESPONSE=$(curl -s -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          "https://api.github.com/repos/${{ github.repository }}/releases" \
          -d "{
            \"tag_name\": \"pre-release\",
            \"target_commitish\": \"${{ github.sha }}\",
            \"name\": \"Pre-release Build (${{ steps.build_info.outputs.commit_short }})\",
            \"body\": $RELEASE_BODY,
            \"draft\": false,
            \"prerelease\": true
          }")
        
        UPLOAD_URL=$(echo "$RESPONSE" | jq -r '.upload_url' | sed 's/{?name,label}//')
        echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT
        echo "âœ… Created new pre-release with detailed build information"
        
    - name: Upload zip file to release
      if: steps.build_step.outputs.build_success == 'true'
      run: |
        echo "ğŸ“¤ Uploading sealdice-ui.zip to release..."
        if curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/zip" \
          --data-binary @sealdice-ui.zip \
          "${{ steps.create_release.outputs.upload_url }}?name=sealdice-ui.zip&label=sealdice-ui.zip"; then
          echo "âœ… Successfully uploaded sealdice-ui.zip to pre-release"
        else
          echo "âŒ Failed to upload zip file"
          exit 1
        fi
        
    - name: Verify release
      if: steps.build_step.outputs.build_success == 'true'
      run: |
        echo ""
        echo "ğŸ‰ Pre-release created successfully!"
        echo ""
        echo "ğŸ“‹ Build Summary:"
        echo "   â° Build time: ${{ steps.build_info.outputs.build_time }}"
        echo "   ğŸ”§ Triggered by: ${{ steps.build_info.outputs.trigger }}"
        echo "   ğŸ“ Commit: ${{ steps.build_info.outputs.commit_short }}"
        echo "   ğŸ“Š Build size: ${{ steps.build_step.outputs.build_size }}"
        echo "   ğŸ“ Files: ${{ steps.build_step.outputs.file_count }}"
        echo ""
        echo "ğŸ”— Download URL:"
        echo "   https://github.com/${{ github.repository }}/releases/download/pre-release/sealdice-ui.zip"
        echo ""
        
    - name: Notify build failure
      if: failure() && steps.build_step.outputs.build_success == 'false'
      run: |
        echo ""
        echo "âŒ Build failed - Pre-release will not be updated"
        echo ""
        echo "ğŸ“‹ Failure Summary:"
        echo "   â° Attempted at: ${{ steps.build_info.outputs.build_time }}"
        echo "   ğŸ”§ Triggered by: ${{ steps.build_info.outputs.trigger }}"
        echo "   ğŸ“ Commit: ${{ steps.build_info.outputs.commit_short }}"
        echo ""
        echo "ğŸ” Please check the build logs above for error details."
        echo ""
        exit 1
